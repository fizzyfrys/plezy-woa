name: Sync Fork with Upstream

on:
  schedule:
    # Check for new releases bi-weekly on the 1st and 15th at 00:00 UTC
    - cron: '0 0 1,15 * *'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      force_sync:
        description: 'Force sync even without new release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get upstream latest release
        id: upstream_release
        run: |
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/edde746/plezy/releases/latest | jq -r '.tag_name')
          echo "latest=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          echo "Upstream latest release: $LATEST_RELEASE"

      - name: Get fork latest tag
        id: fork_tag
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "latest=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Fork latest tag: $LATEST_TAG"

      - name: Check if sync needed
        id: check_sync
        run: |
          if [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
            echo "Force sync requested - syncing regardless of release tags"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.upstream_release.outputs.latest }}" != "${{ steps.fork_tag.outputs.latest }}" ]; then
            echo "New release detected: ${{ steps.upstream_release.outputs.latest }}"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date with ${{ steps.upstream_release.outputs.latest }}"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        if: steps.check_sync.outputs.needs_sync == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and sync
        if: steps.check_sync.outputs.needs_sync == 'true'
        run: |
          git remote add upstream https://github.com/edde746/plezy.git
          git fetch upstream
          git checkout main
          git merge upstream/main --no-edit

      - name: Push changes
        if: steps.check_sync.outputs.needs_sync == 'true'
        run: |
          git push origin main

      - name: Trigger build on sync
        if: steps.check_sync.outputs.needs_sync == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-full.yml',
              ref: 'main',
              inputs: {
                build_x64: 'false',
                build_arm64: 'true'
              }
            });
